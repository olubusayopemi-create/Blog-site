---
import Baselayout from "../../layouts/Baselayout.astro";
export const prerender = false;
import { blogDatabase } from "../../services/databaseService";

const { id } = Astro.params;

// Get logged-in user
const { data: { user } } = await blogDatabase.auth.getUser();

// Fetch post
const { data: post } = await blogDatabase
  .from("posts")
  .select("*")
  .eq("id", id)
  .single();

// Fetch comments
const { data: comments } = await blogDatabase
  .from("comments")
  .select("id, content, created_at, user_id")
  .eq("post_id", id)
  .order("created_at", { ascending: true });

// Handle new comment
let error = "";

if (Astro.request.method === "POST" && user) {
  const formData = await Astro.request.formData();
  const content = formData.get("content")?.toString().trim();
const deleteCommentId = formData.get("delete_comment_id");

if (deleteCommentId) {
  const { error: delErr } = await blogDatabase
    .from("comments")
    .delete()
    .eq("id", deleteCommentId);

  if (delErr) error = delErr.message;
  return Astro.redirect(Astro.url.pathname);
}

  if (!content) {
    error = "Comment cannot be empty.";
  } else {
    await blogDatabase.from("comments").insert({
      post_id: id,
      user_id: user.id,
      content
    });

    return Astro.redirect(`/edit-post/${id}`);
  }
}
---

<Baselayout>
  <div class="post-card">
    <h1 class="post-title">{post?.title}</h1>

    {post?.image_url && (
      <img class="post-image" src={post.image_url} alt={`Image for ${post.title}`} />
    )}

    <p>{post?.content}</p>

    <hr />

    <h2>Comments</h2>

    {comments && comments.length === 0 && <p>No comments yet.</p>}

    {comments && comments.map((comment) => (
      <div class="comment-card">
        <p>{comment.content}</p>
        <small>{new Date(comment.created_at).toLocaleString()}</small>

        {user && comment.user_id === user.id && (
          <form method="POST" style="margin-top:8px;">
            <input type="hidden" name="delete_comment_id" value={comment.id} />
            <button type="submit">Delete</button>
          </form>
        )}
      </div>
    ))}

    {user ? (
      <>
        <h3>Add a comment</h3>
        {error && <p style="color:red">{error}</p>}

        <form method="POST">
          <textarea name="content" rows="4" cols="40"></textarea><br />
          <button type="submit">Post Comment</button>
        </form>
      </>
    ) : (
      <p><a href="/login">Log in</a> to comment.</p>
    )}

    <p><a href="/">‚Üê Back to home</a></p>
  </div>
</Baselayout>