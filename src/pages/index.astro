---
import Baselayout from "../layouts/Baselayout.astro";
export const prerender = false;

import { blogDatabase } from "../services/databaseService";

const { data: { user } } = await blogDatabase.auth.getUser();

// Handle delete
if (Astro.request.method === "POST") {
  const body = await Astro.request.text();
  const params = new URLSearchParams(body);
  const deleteId = params.get("deleteId");

  if (deleteId) {
    await blogDatabase.from("posts").delete().eq("id", deleteId);
    return Astro.redirect("/");
  }
}

// Fetch last 5 posts (newest first)
const { data: posts, error } = await blogDatabase
  .from("posts")
  .select("id, title, content, created_at, user_id, image_url")
  .order("created_at", { ascending: false })
  .limit(5);
---

<Baselayout>
<Fragment slot="nav">
  {user ? (
    <>
      <a href="/new-post">Create post</a>
      <a href="/logout">Log out</a>
    </>
  ) : (
    <>
      <a href="/login">Log in</a>
      <a href="/signup">Sign up</a>
    </>
  )}
</Fragment>

  <h1>Latest Posts</h1>
  {error && <p class="error">{error.message}</p>}

  {posts?.length ? (
  posts.map((post) => (
    <article class="post-card">
      {post.image_url && (
  <a href={`/post/${post.id}`} class="thumb-link">
    <img
      class="post-thumb"
      src={post.image_url}
      alt={`Image for ${post.title}`}
      loading="lazy"
    />
  </a>
)}
      <h3 class="post-title">{post.title}</h3>

      <div class="post-date">
        Posted on {new Date(post.created_at).toLocaleDateString()}
      </div>

      <p>
        {(post.content ?? "").slice(0, 140)}
        {(post.content ?? "").length > 140 ? "..." : ""}
      </p>

      <div class="actions">
        <a href={`/post/${post.id}`}>View</a>

        {user ? (
          <>
            {" | "}
            <a href={`/edit-post/${post.id}`}>Edit</a>
            {" "}
            <form method="POST" style="display:inline">
              <input type="hidden" name="deleteId" value={post.id} />
              <button type="submit">Delete</button>
            </form>
          </>
        ) : null}
      </div>
    </article>
  ))
) : (
  <p>No posts yet.</p>
)}
</Baselayout>